application "hakivo-prod" {

  // TEMPORARILY DISABLED: payments block causes annotation-bucket SmartBucket creation which fails
  // Re-enable after Raindrop fixes SmartBucket index creation
  // payments {
  //   mode = "test"
  // }

  // Environment variables for API keys
  env "WORKOS_API_KEY" {
    secret = true
  }

  env "WORKOS_CLIENT_ID" {
    secret = true
  }

  env "WORKOS_REDIRECT_URI" {
    secret = true
  }

  env "GEOCODIO_API_KEY" {
    secret = true
  }

  env "JWT_SECRET" {
    secret = true
  }

  env "EXA_API_KEY" {
    secret = true
  }

  env "CONGRESS_API_KEY" {
    secret = true
  }

  env "GEMINI_API_KEY" {
    secret = true
  }

  env "CEREBRAS_API_KEY" {
    secret = true
  }

  env "ANTHROPIC_API_KEY" {
    secret = true
  }

  env "ELEVENLABS_API_KEY" {
    secret = true
  }

  env "OPENSTATES_API_KEY" {
    secret = true
  }

  env "PERPLEXITY_API_KEY" {
    secret = true
  }

  env "VULTR_ENDPOINT" {
    secret = true
  }

  env "VULTR_ACCESS_KEY" {
    secret = true
  }

  env "VULTR_SECRET_KEY" {
    secret = true
  }

  env "VULTR_BUCKET_NAME" {
    secret = true
  }

  env "INNGEST_EVENT_KEY" {
    secret = true
  }

  env "INNGEST_SIGNING_KEY" {
    secret = true
  }

  env "PEXELS_API_KEY" {
    secret = true
  }

  env "FEC_API_KEY" {
    secret = true
  }

  // Spreaker OAuth credentials for podcast distribution
  env "SPREAKER_CLIENT_ID" {
    secret = true
  }

  env "SPREAKER_CLIENT_SECRET" {
    secret = true
  }

  env "SPREAKER_SHOW_ID" {
    secret = true
  }

  env "SPREAKER_REDIRECT_URI" {
    secret = true
  }

  // Resend API for email notifications and newsletters
  env "RESEND_API_KEY" {
    secret = true
  }

  // Stripe API keys for subscription payments
  env "STRIPE_SECRET_KEY" {
    secret = true
  }

  env "STRIPE_WEBHOOK_SECRET" {
    secret = true
  }

  // Public-facing HTTP services
  service "auth-service" {
    visibility = "public"
  }

  service "bills-service" {
    visibility = "public"
  }

  service "briefs-service" {
    visibility = "public"
  }

  service "chat-service" {
    visibility = "public"
  }

  service "dashboard-service" {
    visibility = "public"
  }

  service "members-service" {
    visibility = "public"
  }

  service "admin-dashboard" {
    visibility = "public"
  }

  service "db-admin" {
    visibility = "public"
  }

  // Stripe webhook handler - must be public for Stripe to reach
  service "stripe-webhook" {
    visibility = "public"
  }

  // Subscription management API - handles status, checkout, portal, usage tracking
  service "subscription-api" {
    visibility = "public"
  }

  // Inngest webhook handler - disabled due to edge runtime compatibility issues
  // The Inngest SDK has dependencies that don't work with Cloudflare Workers edge runtime
  // service "inngest-service" {
  //   visibility = "public"
  // }

  // Private internal services
  service "user-service" {
    visibility = "private"
  }

  service "congress-api-client" {
    visibility = "private"
  }

  service "geocodio-client" {
    visibility = "private"
  }

  service "claude-client" {
    visibility = "private"
  }

  service "elevenlabs-client" {
    visibility = "private"
  }

  service "cerebras-client" {
    visibility = "private"
  }

  service "exa-client" {
    visibility = "private"
  }

  service "openstates-client" {
    visibility = "private"
  }

  service "vultr-storage-client" {
    visibility = "public"
  }

  service "gemini-tts-client" {
    visibility = "private"
  }

  // Perplexity API client for news search with structured JSON output
  service "perplexity-client" {
    visibility = "private"
  }

  // FEC API client for campaign finance data
  service "fec-client" {
    visibility = "private"
  }

  // Podcast generator service for "100 Laws That Shaped America"
  service "podcast-generator" {
    visibility = "private"
  }

  // Background workers
  observer "brief-generator" {
    source {
      queue = "brief-queue"
    }
  }

  observer "congress-sync-observer" {
    source {
      queue = "sync-queue"
    }
  }

  observer "enrichment-observer" {
    source {
      queue = "enrichment-queue"
    }
  }

  observer "bill-indexing-observer" {
    source {
      queue = "bill-indexing-queue"
    }
  }

  // Scheduled tasks
  task "daily-brief-scheduler" {
    type = "cron"
    cron = "0 7 * * *"
  }

  task "weekly-brief-scheduler" {
    type = "cron"
    cron = "0 7 * * 1"
  }

  task "congress-sync-scheduler" {
    type = "cron"
    cron = "0 2 * * *"
  }

  task "news-sync-scheduler" {
    type = "cron"
    cron = "0 8,14,20 * * *"
  }

  task "congress-actions-scheduler" {
    type = "cron"
    cron = "0 6,18 * * *"
  }

  // State legislation sync - runs daily for user states
  // Fetches state bills from OpenStates API for active user states
  task "state-sync-scheduler" {
    type = "cron"
    cron = "0 3 * * *"  // 3 AM daily (after congress sync at 2 AM)
  }

  // Audio retry task - processes script_ready briefs
  // Uses 4-min fetch timeout, processes 1 brief per run
  task "audio-retry-scheduler" {
    type = "cron"
    cron = "*/5 * * * *"  // Every 5 minutes
  }

  // Podcast generator scheduler - generates next "100 Laws" episode nightly
  task "podcast-scheduler" {
    type = "cron"
    cron = "0 2 * * *"  // Daily at 2 AM UTC
  }

  // Admin utilities
  service "index-bills-service" {
    visibility = "public"
  }

  // Message queues
  queue "brief-queue" {}

  queue "sync-queue" {}

  queue "enrichment-queue" {}

  queue "bill-indexing-queue" {}

  // SQL database for application data
  sql_database "app-db" {}

  // SmartSQL for AI-powered natural language to SQL translation
  // Enables direct textQuery for user questions like "show me healthcare bills"
  smartsql "congressional-db" {}

  // KV caches for performance
  kv_cache "news-cache" {}

  kv_cache "dashboard-cache" {}

  kv_cache "district-cache" {}

  kv_cache "session-cache" {}

  kv_cache "image-cache" {}

  kv_cache "actions-cache" {}

  // Spreaker OAuth token storage
  kv_cache "spreaker-tokens" {}

  // SmartBuckets for document storage with semantic search
  // bill-texts: stores full bill text for RAG retrieval
  smartbucket "bill-texts" {}

  // audio-briefs: stores generated audio files with metadata
  smartbucket "audio-briefs" {}

  // KV cache for agent memory (downgraded from SmartMemory due to initialization issues)
  kv_cache "congressional_memory" {}
}
